<!DOCTYPE html>
<html>
<head>
  <style>
  figure {
    max-width:64rem;
    width:100%;
    max-height:30.875rem;
    height:100%;
    margin:1.25rem auto;
    padding:1.051%;
    background-color:#666;
  }
  .controls {
    width:100%;
    height:8.0971659919028340080971659919028%; /* of figure's height */
    position:relative;
  }
  .controls[data-state=hidden] {
    display:none;
  }

  .controls[data-state=visible] {
    display:block;
  }
  .controls > * {
    float:left;
    /* width:3.90625%; */
    height:100%;
    margin-left:0.1953125%;
    display:block;
  }

  .controls > *:first-child {
    margin-left:0;
  }
  .controls .progress {
    cursor:pointer;
    width:75.390625%;
  }
  .controls button {
    border:none;
    cursor:pointer;
    background:transparent;
    background-size:contain;
    background-repeat:no-repeat;
  }
  .controls button:hover, .controls button:focus {
    opacity:0.5;
  }
  .controls button[data-state="play"] {
    /* background-image: url('data:image/png;base64,iVBORw0KGgoAAA ... '); */
  }

  .controls button[data-state="pause"] {
    /* background-image: url('data:image/png;base64,iVBORw0KGgoAAA ... '); */
  }
  /* .controls progress {
  display:block;
  width:100%;
  height:81%;
  margin-top:0.125rem;
  border:none;
  color:#0095dd;
  -moz-border-radius:2px;
  -webkit-border-radius:2px;
  border-radius:2px;
}
.controls progress[data-state="fake"] {
background:#e6e6e6;
height:65%;
}
.controls progress span {
width:0%;
height:100%;
display:inline-block;
background-color:#2a84cd;
}
.controls progress::-moz-progress-bar {
background-color:#0095dd;
}

.controls progress::-webkit-progress-value {
background-color:#0095dd;
} */
</style>
</head>
<body>
  <div id="info"></div>
  <div id="videoControls" class="controls" data-state="hidden">
    <button id="playpause" type="button" data-state="play">Play/Pause</button>
    <button id="stop" type="button" data-state="stop">Stop</button>
    <div class="progress">
      <progress id="progress" value="0" min="0">
        <span id="progress-bar"></span>
      </progress>
    </div>
    <button id="mute" type="button" data-state="mute">Mute/Unmute</button>
    <button id="volinc" type="button" data-state="volup">Vol+</button>
    <button id="voldec" type="button" data-state="voldown">Vol-</button>
    <button id="fs" type="button" data-state="go-fullscreen">Fullscreen</button>
  </div>


  <video width=400 ></video>
  <script>
  (function(){
    var video = document.querySelector('video');

    var playpause = document.getElementById('playpause');
    var stop = document.getElementById('stop');
    var mute = document.getElementById('mute');
    var volinc = document.getElementById('volinc');
    var voldec = document.getElementById('voldec');
    var progress = document.getElementById('progress');
    var progressBar = document.getElementById('progress-bar');
    var fullscreen = document.getElementById('fs');

    // Display the user defined video controls
    videoControls.setAttribute('data-state', 'visible');
    var supportsProgress = (document.createElement('progress').max !== undefined);
    if (!supportsProgress) progress.setAttribute('data-state', 'fake');
    var changeButtonState = function(type) {
      // Play/Pause button
      if (type == 'playpause') {
        if (video.paused || video.ended) {
          playpause.setAttribute('data-state', 'play');
        }
        else {
          playpause.setAttribute('data-state', 'pause');
        }
      }
      // Mute button
      else if (type == 'mute') {
        mute.setAttribute('data-state', video.muted ? 'unmute' : 'mute');
      }
    }
    video.addEventListener('play', function() {
      changeButtonState('playpause');
    }, false);
    video.addEventListener('pause', function() {
      changeButtonState('playpause');
    }, false);
    stop.addEventListener('click', function(e) {
      video.pause();
      video.currentTime = 0;
      progress.value = 0;
      // Update the play/pause button's 'data-state' which allows the correct button image to be set via CSS
      changeButtonState('playpause');
    });
    reverse = null;
    mute.addEventListener('click', function(e) {
      // video.playbackRate = -1;
      // return;
      // video.currentTime -= 0.5;
      // setInterval(() => video.pause());
      clearInterval(reverse);
      video.pause();
      reverse = setInterval(() => {
        video.currentTime -= 0.1;
        if (video.currentTime<0.1) {
          clearInterval(reverse);
        }
      }, 100);
      return;
      changeButtonState('mute');
    });
    playpause.addEventListener('click', function(e) {
      clearInterval(reverse);
      if (video.paused || video.ended) video.play();
      else video.pause();
    });
    var checkVolume = function(dir) {
      if (dir) {
        var currentVolume = Math.floor(video.volume * 10) / 10;
        if (dir === '+') {
          if (currentVolume < 1) video.volume += 0.1;
        }
        else if (dir === '-') {
          if (currentVolume > 0) video.volume -= 0.1;
        }
        // If the volume has been turned off, also set it as muted
        // Note: can only do this with the custom control set as when the 'volumechange' event is raised, there is no way to know if it was via a volume or a mute change
        if (currentVolume <= 0) video.muted = true;
        else video.muted = false;
      }
      changeButtonState('mute');
    }
    var alterVolume = function(dir) {
      checkVolume(dir);
    }
    video.addEventListener('volumechange', function() {
      checkVolume();
    }, false);
    progress.addEventListener('click', function(e) {
      var pos = (e.pageX  - (this.offsetLeft + this.offsetParent.offsetLeft)) / this.offsetWidth;
      video.currentTime = pos * video.duration;
    });
    video.addEventListener('loadedmetadata', function() {
    });
    video.addEventListener('timeupdate', function() {
      progress.setAttribute('max', video.duration);
      progress.value = video.currentTime;
      progressBar.style.width = Math.floor((video.currentTime / video.duration) * 100) + '%';
    });

    var startDate = new Date('2020-10-16T16:45:24.083Z');
    console.log(startDate);
    console.log(new Date(startDate.getTime() + 5000));

    var mimeCodec = "video/webm; codecs=vp9";
    var assetURL = 'https://aliconnect.nl/shared/videorecorder/1_20201019T230320100Z_';
    for (var i=1, urls = []; i<=145; i++) {
      urls.push(assetURL + i + '.webm');
    }
    if ('MediaSource' in window && MediaSource.isTypeSupported(mimeCodec)) {
      var mediaSource = new MediaSource();
      video.src = URL.createObjectURL(mediaSource);
      mediaSource.addEventListener('sourceopen', event => {
        mediaSource.duration = 0;
        function get (url, cb) {
          if (!url) return;
          var xhr = new XMLHttpRequest;
          xhr.open('get', url);
          // info.innerText = url;
          // console.log('GET',url);
          xhr.responseType = 'arraybuffer';
          xhr.onload = event => cb (xhr.response);
          xhr.send();
        }
        let sourceBuffer = mediaSource.addSourceBuffer(mimeCodec);
        sourceBuffer.mode = 'sequence';
        sourceBuffer.addEventListener('updateend', event => {
          console.log('updateend', mediaSource.readyState, mediaSource.duration);
          if (!urls.length) mediaSource.endOfStream();
        });
        video.addEventListener('timeupdate', event => {
          info.innerText=`${new Date(startDate.getTime() + video.currentTime * 1000).toLocaleString()}`;
          if (mediaSource.duration - video.currentTime < 1) {
            get (urls.shift(), response => sourceBuffer.appendBuffer(response));
          }
        });
        // video.addEventListener('canplay', event => video.play());
        get (urls.shift(), response => sourceBuffer.appendBuffer(response))
      });

    } else {
      console.error('Unsupported MIME type or codec: ', mimeCodec);
    }
  })()
</script>
</body>
</html>
